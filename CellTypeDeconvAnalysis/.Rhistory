d = data.frame(Subject = u,Method = 'NNLS',lsDarmanis[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'cibersort',t(csDarmanis[,u]))
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA',t(dsaDarmanis[,u]))
df4 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'dtangle',dtDarmanis[u,])
df5 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Single gene',Subject = u,markerGene[u,])
dfmarker = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(dfmarker,df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
msedf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
mse())[-6,'IHC'])
set.seed(51773)
sampMSE2 = list()
for(i in 1:10000){
u2 = sample(rownames(lsDarmanis),length(u),replace = FALSE)
d = data.frame(Subject = u,Method = 'NNLS',lsDarmanis[u2,])
DF2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'cibersort',t(csDarmanis[,u2]))
DF3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA',t(dsaDarmanis[,u2]))
DF4 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'dtangle',dtDarmanis[u2,])
DF5 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'Single gene',markerGene[u2,])
DFmarker = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(DFmarker,DF2,DF3,DF4,DF5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
rownames(df) = NULL
sampMSE2[[i]] =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
mse())[-6,'IHC'])
}
head(samp)
head(gen)
head(gene)
dim(exons)
rowSums(exons)
sum(rowSums(exons)==0)
dim(exons)
write.csv(exons[1:25000,], file = 'Data/human_LGN_2018-06-14_exon-matrix_1.csv')
write.csv(exons[25001:50281,], file = 'Data/human_LGN_2018-06-14_exon-matrix_2.csv')
exons1 = read.csv('Data/human_LGN_2018-06-14_exon-matrix_1.csv', row.names = 1)
exons2 = read.csv('Data/human_LGN_2018-06-14_exon-matrix_2.csv', row.names = 1)
exons = rbind(exons1,exons2)
rownames(exons) = gene$gene
exons[1:4,]
exons[1:4,1:4]
dim(exons)
int = unique(c(names(IHCneuro),names(IHCmicroglia),names(IHCastro),names(IHColigo),names(IHCendo)))
IHCprops = data.frame(neuro = IHCneuro[int], astro = IHCastro[int], microglia = IHCmicroglia[int], oligo = IHColigo[int], endo = IHCendo[int], row.names = int)
x = t(IHCprops[order(IHCprops$neuro),])
x = x[,!is.na(colSums(x))]
x
dim(x)
colnames(x)
library(openxlsx)
wb <- createWorkbook("Figures.xlsx")
addWorksheet(wb, 'Figure1b')
writeData(wb,  'Figure1b', x)
getwd()
?createWorkbook
wb <- createWorkbook("Figures.xlsx")
addWorksheet(wb, 'Figure1b')
writeData(wb,  'Figure1b', x)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
head(x)
?writeData
wb <- createWorkbook("Figures.xlsx")
addWorksheet(wb, 'Figure1b')
writeData(wb,  'Figure1b', x,rownames = TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
wb <- createWorkbook("Figures.xlsx")
addWorksheet(wb, 'Figure1b')
writeData(wb,  'Figure1b', x,rowNames = TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
PVAL = apply(geneResid[,rownames(IHCprops)],1,function(y){
fit = summary(lm(as.numeric(y)~.,IHCprops))
pf(fit$fstatistic[1],fit$fstatistic[2],fit$fstatistic[3], lower.tail = FALSE)
})
ggplot(data.frame(pval = PVAL),aes(x = pval))+geom_histogram(bins = 20, boundary=0,linetype=1, alpha=.25, color="gray50", fill="gray70")+theme_classic() + ylab("Count") + xlab("P-value") + ggtitle("Genes associated with cell-types") + xlim(0,1) +
scale_y_continuous(expand = expand_scale(mult = c(0, .1)))
head(pval)
addWorksheet(wb, 'Figure1c')
writeData(wb,  'Figure1c', pval,rowNames = TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
head(t(x))
head(t(pval))
writeData(wb,  'Figure1c', t(pval),rowNames = TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
addWorksheet(wb, 'Figure1c')
writeData(wb,  'Figure1c', t(pval),rowNames = TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
removeWorksheet(wb, 'Figure1c')
addWorksheet(wb, 'Figure1c')
writeData(wb,  'Figure1c', t(pval),rowNames = TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
head( t(t(pval)))
writeData(wb,  'Figure1c', t(t(pval)),rowNames = TRUE,colNames=FALSE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
removeWorksheet(wb, 'Figure1c')
addWorksheet(wb, 'Figure1c')
writeData(wb,  'Figure1c', t(t(pval)),rowNames = TRUE,colNames=FALSE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
head(modResid)
u = rownames(modResid)
df = rbind(modResid[c('21','106','116','110','112'),],endo = IHCendo[u],oligo = IHColigo[u],microglia = IHCmicroglia[u],neuro = IHCneuro[u],astro = IHCastro[u])
df[,1:4]
head(IHCmicroglia)
dim(df)
u = intersect(rownames(modResid),names(IHCendo))
df = rbind(modResid[c('21','106','116','110','112'),],endo = IHCendo[u],oligo = IHColigo[u],microglia = IHCmicroglia[u],neuro = IHCneuro[u],astro = IHCastro[u])
u = intersect(rownames(modResid),names(IHCendo))
df = rbind(modResid[c('21','106','116','110','112'),],endo = IHCendo[u],oligo = IHColigo[u],microglia = IHCmicroglia[u],neuro = IHCneuro[u],astro = IHCastro[u])
addWorksheet(wb, 'FigureS1')
writeData(wb,  'FigureS1', df,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = intersect(rownames(IHCprops),colnames(dsaDarmanis))
d = data.frame(Subject = u,Method = 'IHC',IHCprops[u,])
df1 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'NNLS',lsDarmanis[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'cibersort',t(csDarmanis[,u]))
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA',t(dsaDarmanis[,u]))
df4 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'dtangle',dtDarmanis[u,])
df5 = reshape2::melt(d,id.vars = c('Subject','Method'))
cmap = c('Neurons','Astrocytes','Microglia','Oligodendrocytes','Endothelial cells')
names(cmap) = c('neuro','astro','microglia','oligo','endo')
df = rbind(df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
pal = brewer.pal(8, 'Set2')
col = c(IHC = pal[1], DSA = pal[2], dtangle = pal[3], cibersort = pal[4], NNLS = pal[5], modules = pal[6], 'Single gene' = pal[7] )
markerGene = t(geneExpr[c("RBFOX3","GFAP","AIF1","OLIG2","CD34"),])
colnames(markerGene) = c('neuro','astro','microglia','oligo','endo')
modCell = t(modResid[c("21","106","116","110","112"),])
colnames(modCell) = c('neuro','astro','microglia','oligo','endo')
d = data.frame(Subject = u,Method = 'Single gene',markerGene[u,])
dfmarker = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(dfmarker,df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-7,'IHC'])
cordf
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
ggplot(cordf2,aes(x = Celltype,y = value,colour = Method,fill = Method))+ geom_bar(width=0.5, position = position_dodge(width=0.8), stat = "identity") + theme_classic(16) + ylab("Correlation coefficient") + xlab('Cell-type') + scale_fill_manual(values=col) + scale_colour_manual(values=col) + geom_hline(yintercept=qSpearman(0.95,length(u)),linetype="dotted") +  annotate(geom="text",y=qSpearman(0.95, length(u))+0.01, x=5.9, label="    p=0.05", color="black",size = 2.75,hjust = 1,vjust = 0) + ylim(-0.02,0.6) + theme(axis.title.x=element_text(vjust=8,hjust = 0.4), axis.text.x=element_text(angle=45,hjust=1), legend.title=element_text(size=14,vjust=-1), legend.text=element_text(size=12), legend.position=c(0.85,0.86), legend.key.size=unit(0.15,"in"))
head(cordf)
addWorksheet(wb, 'FigureS4')
writeData(wb,  'FigureS4', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
markers = lapply(DarmanisMarkersFull,function(x)x)
dsaDarmanis1000<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:500])
dsaDarmanis500<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:200])
dsaDarmanis200<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:75])
dsaDarmanis75<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:50])
dsaDarmanis50<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:25])
dsaDarmanis25<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:5])
dsaDarmanis5<-getcompM(geneResid,method="DSA",marker=markers)
u = intersect(rownames(IHCprops),colnames(dsaDarmanis))
d = data.frame(Subject = u,Method = 'DSA1000',t(dsaDarmanis1000[,u]))
df1000 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA500',t(dsaDarmanis500[,u]))
df500 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA200',t(dsaDarmanis200[,u]))
df200 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA100',t(dsaDarmanis[,u]))
df100 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA75',t(dsaDarmanis75[,u]))
df75 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA50',t(dsaDarmanis50[,u]))
df50 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA25',t(dsaDarmanis25[,u]))
df25 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA5',t(dsaDarmanis5[,u]))
df5 = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(df5,df25,df50,df75,df100,df200,df500,df1000,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
pal2 = brewer.pal(8, 'Set2')
pal3 = brewer.pal(9, 'Blues')
col = c( IHC = pal2[1],DSA1000 = pal3[8],DSA500 = pal3[7],DSA200 = pal3[6], DSA100 = pal3[5], DSA75 = pal3[4], DSA50 = pal3[3], DSA25 = pal3[2], DSA5 = pal3[1] )
ggplot(df,aes(x = variable,y = value,color = Method,fill = Method))+geom_boxplot()+theme_classic(16)+ylab('Proportion')+xlab('Cell-type')+scale_colour_manual(values = col)+scale_fill_manual(values = col)+ theme(axis.title.x = element_text(vjust=8, hjust=0.4),axis.text.x = element_text(angle = 45,hjust = 1), legend.title = element_text(size=16,vjust=-1),legend.text = element_text(size = 12),legend.position = c(0.2, 0.83),legend.key.size = unit(0.17, "in"))
head(df)
dim(df)
addWorksheet(wb, 'FigureS7a')
writeData(wb,  'FigureS7a', df,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-7,'IHC'])
cordf
pal2 = brewer.pal(8, 'Set2')
pal3 = brewer.pal(9, 'Blues')
col = c( IHC = pal2[1],DSA1000 = pal3[8],DSA500 = pal3[7],DSA200 = pal3[6], DSA100 = pal3[5], DSA75 = pal3[4], DSA50 = pal3[3], DSA25 = pal3[2], DSA5 = pal3[1] )
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
addWorksheet(wb, 'FigureS7b')
writeData(wb,  'FigureS7b', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = intersect(rownames(IHCprops),colnames(dsaZhang))
d = data.frame(Subject = u,Method = 'IHC',IHCprops[u,])
df1 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'NNLS',lsZhang[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'cibersort',t(csZhang[,u]))
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'dtangle',dtZhang[u,])
df4 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA',t(dsaZhang[,u]))
df5 = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
pal = brewer.pal(8, 'Set2')
col = c(IHC = pal[1], DSA = pal[2], dtangle = pal[3], cibersort = pal[4], NNLS = pal[5], modules = pal[6], 'Single gene' = pal[7] )
```{r Fig2b_xlsx}
addWorksheet(wb, 'Figure2b')
writeData(wb,  'Figure2b', df,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
```
markerGene = t(geneExpr[c("RBFOX3","GFAP","AIF1","OLIG2","CD34"),])
colnames(markerGene) = c('neuro','astro','microglia','oligo','endo')
d = data.frame(Subject = u,Method = 'Single gene',markerGene[u,])
dfmarker = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'modules',modCell[u,])
dfmod = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(dfmarker,df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-7,'IHC'])
cordf
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
addWorksheet(wb, 'Figure2a')
writeData(wb,  'Figure2a', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = colnames(geneResid)
df2 = data.frame(Method = 'NNLS',Subject = u,lsZhang[u,])
df3 = data.frame(Method = 'cibersort',Subject = u,t(csZhang[,u]))
df4 = data.frame(Method = 'dtangle',Subject = u,dtZhang[u,])
df5 = data.frame(Method = 'DSA',Subject = u,t(dsaZhang[,u]))
dfmarker = data.frame(Method = 'Single gene',Subject = u,markerGene[u,])
dfmod = data.frame(Method = 'modules',Subject = u,modCell[u,])
df = rbind(dfmod,dfmarker,df2,df3,df4,df5)
colnames(df)[!colnames(df)%in%c('Subject','Method')] = cmap[colnames(df)[!colnames(df)%in%c('Subject','Method')]]
dfGather = gather(df,Cell, value, -Method,-Subject)
dfGather$cellMethod = gsub(' ','.',paste(dfGather$Cell,dfGather$Method,sep = '.'))
dfGather = dplyr::select(dfGather, -Cell, -Method)
dfSpread = spread(dfGather,cellMethod,value)
dfSpread = dplyr::select(dfSpread, -Subject)
spreadCor = cor(dfSpread)
addWorksheet(wb, 'FigureS3')
writeData(wb,  'FigureS3', spreadCor,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = rownames(IHCprops)
df2 = data.frame(Method = 'Darmanis',Subject = u,t(dsaDarmanis)[u,])
df3 = data.frame(Method = 'Zhang',Subject = u,t(dsaZhang)[u,])
df4 = data.frame(Method = 'NeuroExpresso',Subject = u,t(dsaNeuroExpresso)[u,])
dfmarker = data.frame(Method = 'Single gene',Subject = u,markerGene[u,])
df = rbind(df2,df3,df4)
colnames(df)[!colnames(df)%in%c('Subject','Method')] = cmap[colnames(df)[!colnames(df)%in%c('Subject','Method')]]
dfGather = gather(df,Cell, value, -Method,-Subject)
dfGather$cellMethod = gsub(' ','.',paste(dfGather$Cell,dfGather$Method,sep = '.'))
dfGather = dplyr::select(dfGather, -Cell, -Method)
dfSpread = spread(dfGather,cellMethod,value)
dfSpread = dplyr::select(dfSpread, -Subject)
spreadCor = cor(dfSpread)
addWorksheet(wb, 'FigureS2')
writeData(wb,  'FigureS2', spreadCor,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = rownames(IHCprops)
d = data.frame(Subject = u,Method = 'IHC',IHCprops[u,])
df1 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Darmanis',Subject = u,t(dsaDarmanis)[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Zhang',Subject = u,t(dsaZhang)[u,])
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'NeuroExpresso',Subject = u,t(dsaNeuroExpresso)[u,])
df4 = reshape2::melt(d,id.vars = c('Subject','Method'))
cmap = c('Neurons','Astrocytes','Microglia','Oligodendrocytes','Endothelial cells')
names(cmap) = c('neuro','astro','microglia','oligo','endo')
df = rbind(df1,df2,df3,df4)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-1,'IHC'])
cordf
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
addWorksheet(wb, 'FigureS7b')
writeData(wb,  'FigureS7b', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
markers = lapply(DarmanisMarkersFull,function(x)x)
dsaDarmanis1000<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:500])
dsaDarmanis500<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:200])
dsaDarmanis200<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:75])
dsaDarmanis75<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:50])
dsaDarmanis50<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:25])
dsaDarmanis25<-getcompM(geneResid,method="DSA",marker=markers)
markers = lapply(DarmanisMarkersFull,function(x)x[1:5])
dsaDarmanis5<-getcompM(geneResid,method="DSA",marker=markers)
u = intersect(rownames(IHCprops),colnames(dsaDarmanis))
d = data.frame(Subject = u,Method = 'DSA1000',t(dsaDarmanis1000[,u]))
df1000 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA500',t(dsaDarmanis500[,u]))
df500 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA200',t(dsaDarmanis200[,u]))
df200 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA100',t(dsaDarmanis[,u]))
df100 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA75',t(dsaDarmanis75[,u]))
df75 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA50',t(dsaDarmanis50[,u]))
df50 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA25',t(dsaDarmanis25[,u]))
df25 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA5',t(dsaDarmanis5[,u]))
df5 = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(df5,df25,df50,df75,df100,df200,df500,df1000,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-7,'IHC'])
cordf
pal2 = brewer.pal(8, 'Set2')
pal3 = brewer.pal(9, 'Blues')
col = c( IHC = pal2[1],DSA1000 = pal3[8],DSA500 = pal3[7],DSA200 = pal3[6], DSA100 = pal3[5], DSA75 = pal3[4], DSA50 = pal3[3], DSA25 = pal3[2], DSA5 = pal3[1] )
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
writeData(wb,  'FigureS7b', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = intersect(rownames(IHCprops),colnames(dsaZhang))
d = data.frame(Subject = u,Method = 'IHC',IHCprops[u,])
df1 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'NNLS',lsZhang[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'cibersort',t(csZhang[,u]))
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'dtangle',dtZhang[u,])
df4 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'DSA',t(dsaZhang[,u]))
df5 = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
addWorksheet(wb, 'Figure2b')
writeData(wb,  'Figure2b', df,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
markerGene = t(geneExpr[c("RBFOX3","GFAP","AIF1","OLIG2","CD34"),])
colnames(markerGene) = c('neuro','astro','microglia','oligo','endo')
d = data.frame(Subject = u,Method = 'Single gene',markerGene[u,])
dfmarker = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Subject = u,Method = 'modules',modCell[u,])
dfmod = reshape2::melt(d,id.vars = c('Subject','Method'))
df = rbind(dfmarker,df2,df3,df4,df5,df1)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-7,'IHC'])
cordf
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
addWorksheet(wb, 'Figure2a')
writeData(wb,  'Figure2a', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = colnames(geneResid)
df2 = data.frame(Method = 'NNLS',Subject = u,lsZhang[u,])
df3 = data.frame(Method = 'cibersort',Subject = u,t(csZhang[,u]))
df4 = data.frame(Method = 'dtangle',Subject = u,dtZhang[u,])
df5 = data.frame(Method = 'DSA',Subject = u,t(dsaZhang[,u]))
dfmarker = data.frame(Method = 'Single gene',Subject = u,markerGene[u,])
dfmod = data.frame(Method = 'modules',Subject = u,modCell[u,])
df = rbind(dfmod,dfmarker,df2,df3,df4,df5)
colnames(df)[!colnames(df)%in%c('Subject','Method')] = cmap[colnames(df)[!colnames(df)%in%c('Subject','Method')]]
dfGather = gather(df,Cell, value, -Method,-Subject)
dfGather$cellMethod = gsub(' ','.',paste(dfGather$Cell,dfGather$Method,sep = '.'))
dfGather = dplyr::select(dfGather, -Cell, -Method)
dfSpread = spread(dfGather,cellMethod,value)
dfSpread = dplyr::select(dfSpread, -Subject)
spreadCor = cor(dfSpread)
addWorksheet(wb, 'FigureS3')
writeData(wb,  'FigureS3', spreadCor,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = rownames(IHCprops)
df2 = data.frame(Method = 'Darmanis',Subject = u,t(dsaDarmanis)[u,])
df3 = data.frame(Method = 'Zhang',Subject = u,t(dsaZhang)[u,])
df4 = data.frame(Method = 'NeuroExpresso',Subject = u,t(dsaNeuroExpresso)[u,])
dfmarker = data.frame(Method = 'Single gene',Subject = u,markerGene[u,])
df = rbind(df2,df3,df4)
colnames(df)[!colnames(df)%in%c('Subject','Method')] = cmap[colnames(df)[!colnames(df)%in%c('Subject','Method')]]
dfGather = gather(df,Cell, value, -Method,-Subject)
dfGather$cellMethod = gsub(' ','.',paste(dfGather$Cell,dfGather$Method,sep = '.'))
dfGather = dplyr::select(dfGather, -Cell, -Method)
dfSpread = spread(dfGather,cellMethod,value)
dfSpread = dplyr::select(dfSpread, -Subject)
spreadCor = cor(dfSpread)
u = rownames(IHCprops)
df2 = data.frame(Method = 'Darmanis',Subject = u,t(dsaDarmanis)[u,])
df3 = data.frame(Method = 'Zhang',Subject = u,t(dsaZhang)[u,])
df4 = data.frame(Method = 'NeuroExpresso',Subject = u,t(dsaNeuroExpresso)[u,])
dfmarker = data.frame(Method = 'Single gene',Subject = u,markerGene[u,])
df = rbind(df2,df3,df4)
colnames(df)[!colnames(df)%in%c('Subject','Method')] = cmap[colnames(df)[!colnames(df)%in%c('Subject','Method')]]
dfGather = gather(df,Cell, value, -Method,-Subject)
dfGather$cellMethod = gsub(' ','.',paste(dfGather$Cell,dfGather$Method,sep = '.'))
dfGather = dplyr::select(dfGather, -Cell, -Method)
dfSpread = spread(dfGather,cellMethod,value)
dfSpread = dplyr::select(dfSpread, -Subject)
spreadCor = cor(dfSpread)
lmat = cbind(c(0,4),c(0,2),c(3,1))
lwid = c(0.25,0.01,3)
lhei = c(0.2,2)
colh = colorRampPalette(c("blue","white","red"))(500)[101:400]
heatmap.2(spreadCor,,dendrogram = "none",Rowv = NULL,Colv = "Rowv",
trace = "none",scale = "none",offsetRow = 0.3, offsetCol = 0.3,
colsep = c(3,6,9,12),sepwidth=c(0.05,0.05), rowsep = c(3,6,9,12), margin = c(14,14),key = F,lmat = lmat, lwid = lwid,lhei = lhei,col = colh)
col.labels<-c("-1","0","1")
# this will put the labels at the intersections
# col.labels<-c("","Cold","","Warm","","Warmer","","Hot","")
color.legend(-.07,.3,-.045,.8,col.labels,colh,gradient="y")
u = rownames(IHCprops)
d = data.frame(Subject = u,Method = 'IHC',IHCprops[u,])
df1 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Darmanis',Subject = u,t(dsaDarmanis)[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Zhang',Subject = u,t(dsaZhang)[u,])
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'NeuroExpresso',Subject = u,t(dsaNeuroExpresso)[u,])
df4 = reshape2::melt(d,id.vars = c('Subject','Method'))
cmap = c('Neurons','Astrocytes','Microglia','Oligodendrocytes','Endothelial cells')
names(cmap) = c('neuro','astro','microglia','oligo','endo')
df = rbind(df1,df2,df3,df4)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
pal = c(brewer.pal(8, 'Set2')[1],brewer.pal(9, 'Set1')[c(8,2)],brewer.pal(6, 'Oranges')[5])
col = c(IHC = pal[1], Darmanis = pal[2], Zhang = pal[3], NeuroExpresso = pal[4] )
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-1,'IHC'])
cordf
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
ggplot(cordf2,aes(x = Celltype,y = value,colour = Method,fill = Method))+ geom_bar(width=0.5, position = position_dodge(width=0.8), stat = "identity") + theme_classic(16) + ylab("Correlation coefficient") + xlab('Cell-type') + scale_fill_manual(values=col) + scale_colour_manual(values=col) + geom_hline(yintercept=qSpearman(0.95,length(u)),linetype="dotted") +  annotate(geom="text",y=qSpearman(0.95, length(u))+0.01, x=5.9, label="    p=0.05", color="black",size = 2.75,hjust = 1,vjust = 0) + ylim(-0.02,0.6) + theme(axis.title.x=element_text(vjust=8,hjust = 0.4), axis.text.x=element_text(angle=45,hjust=1), legend.title=element_text(size=14,vjust=-1), legend.text=element_text(size=12), legend.position=c(0.85,0.86), legend.key.size=unit(0.15,"in"))
addWorksheet(wb, 'FigureS4')
writeData(wb,  'FigureS4', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
u = rownames(IHCprops)
d = data.frame(Subject = u,Method = 'IHC',IHCprops[u,])
df1 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Darmanis',Subject = u,dtDarmanis[u,])
df2 = reshape2::melt(d,id.vars = c('Subject','Method'))
d = data.frame(Method = 'Zhang',Subject = u,dtZhang[u,])
df3 = reshape2::melt(d,id.vars = c('Subject','Method'))
cmap = c('Neurons','Astrocytes','Microglia','Oligodendrocytes','Endothelial cells')
names(cmap) = c('neuro','astro','microglia','oligo','endo')
df = rbind(df1,df2,df3)
levels(df$variable) = cmap[levels(df$variable)]
df$variable = factor(df$variable,levels = sort(levels(df$variable)))
pal = c(brewer.pal(8, 'Set2')[1],brewer.pal(9, 'Set1')[c(8,2)],brewer.pal(6, 'Oranges')[5])
col = c(IHC = pal[1], Darmanis = pal[2], Zhang = pal[3] )
cordf =sapply(levels(df$variable),function(x)(df %>% spread(Method, value) %>%
filter(variable==x) %>%
dplyr::select(-Subject,-variable) %>%
cor(method = 'spearman',use = 'complete'))[-1,'IHC'])
cordf
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
cordf2 = reshape2::melt(cordf,c('Method','Celltype'))
cordf2 = filter(cordf2, Method!='IHC')
ggplot(cordf2,aes(x = Celltype,y = value,colour = Method,fill = Method))+ geom_bar(width=0.5, position = position_dodge(width=0.8), stat = "identity") + theme_classic(16) + ylab("Correlation coefficient") + xlab('Cell-type') + scale_fill_manual(values=col) + scale_colour_manual(values=col) + geom_hline(yintercept=qSpearman(0.95,length(u)),linetype="dotted") +  annotate(geom="text",y=qSpearman(0.95, length(u))+0.01, x=5.9, label="    p=0.05", color="black",size = 2.75,hjust = 1,vjust = 0) + ylim(-0.02,0.6) + theme(axis.title.x=element_text(vjust=8,hjust = 0.4), axis.text.x=element_text(angle=45,hjust=1), legend.title=element_text(size=14,vjust=-1), legend.text=element_text(size=12), legend.position=c(0.85,0.86), legend.key.size=unit(0.15,"in"))
addWorksheet(wb, 'FigureS4b')
writeData(wb,  'FigureS4b', cordf,rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
addWorksheet(wb, 'FigureS6')
writeData(wb,  'FigureS6', data.frame(Correlation = diag2, Celltype =ct),rowNames = TRUE,colNames=TRUE)
saveWorkbook(wb, file = "Figures.xlsx", overwrite = TRUE)
?saveWorkbook
